from .strategy import SPStrategy
from flwr.common.logger import log
from logging import DEBUG

import numpy as np

class AccuracyVariance(SPStrategy):

    def __init__(self, last_k_data: int, var_threshold: float, clear_on_switch: bool = True):
        super(AccuracyVariance, self).__init__()
        self.k = last_k_data
        self.var_thres = var_threshold
        self.cos = clear_on_switch

    def should_switch(self) -> bool:
        data = self.data[-self.k:]
        if len(data) == self.k:
            var = np.var(data)
            log(DEBUG, f"AccuracyVariance: sample variance {var} (last {self.k} data)")
            if np.var(data) < self.var_thres:
                if self.cos:
                    self.data.clear()
                log(DEBUG, "AccuracyVariance: should switch")
                return True
        return False
